var vue=new BaseVue({el:"#vueApp",data:{profile:profile,description:"",all_tree_count:all_tree_count,color:"",color_number:"",user_progress:"",next_color:"",web_data:null,web_data_loaded:!1,graph_data:[],chart_alltime:null,chart_year:null,chart_quarter:null,chart_month:null,chart_web:{},chart_pie:[],tracking_code:tracking_code,aggregated:{species_categories:{alltime:0},most_planted_species:{alltime:0}},current_filter:"alltime",common_options:{},map_projects:[],ajax_url:ajax_url,project:{slug:"-"},details:{CO2_offset_period:"0,0",productivity_period:"0,0",image:""},specie_names_expanded:!0,split_at:4,periods_loaded:{alltime:!1,year:!1,quarter:!1,month:!1},period_has_data:{alltime:!1,year:!1,quarter:!1,month:!1},periods_by_id:{0:"alltime",1:"year",2:"quarter",3:"month"},periods_by_name:{alltime:0,year:1,quarter:2,month:3}},created:function(){$("#js--tracking-code").click((function(){$(this).select();var e,t;document.body.createTextRange?((e=document.body.createTextRange()).moveToElementText(this),e.select()):window.getSelection&&(t=window.getSelection(),(e=document.createRange()).selectNodeContents(this),t.removeAllRanges(),t.addRange(e))})),this.resetVars(),moment.locale(this.currentLocale);var e=this;$("#select-period").on("change",(function(t){e.changeFilter(t.target.value)})),this.emptyDescription(this.profile),this.navbarColor(),this.loadPeriods(!0),this.loadWebData()},methods:{resetVars:function(){var e=["planted","reforested","co2","species_categories","most_planted_species"];for(var t in e){this.aggregated[e[t]]=[];for(var a=0;a<=3;a++)this.aggregated[e[t]][this.periods_by_id[a]]=[]}},translateThisLabel:function(e){return month=e.match(/January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|Jun|Jul|Aug|Sep|Oct|Nov|Dec/g),month?(translation=this.translateMonth(month[0]),e.replace(month,translation,"g")):e},translateMonth:function(e){var t=e;switch(e){case"January":t="month_1";break;case"February":t="month_2";break;case"March":t="month_3";break;case"April":t="month_4";break;case"May":t="month_5";break;case"June":t="month_6";break;case"July":t="month_7";break;case"August":t="month_8";break;case"September":t="month_9";break;case"October":t="month_10";break;case"November":t="month_11";break;case"December":t="month_12";break;case"Jan":t="month_1_abbr";break;case"Feb":t="month_2_abbr";break;case"Mar":t="month_3_abbr";break;case"Apr":t="month_4_abbr";break;case"May":t="month_5_abbr";break;case"Jun":t="month_6_abbr";break;case"Jul":t="month_7_abbr";break;case"Aug":t="month_8_abbr";break;case"Sep":t="month_9_abbr";break;case"Oct":t="month_10_abbr";break;case"Nov":t="month_11_abbr";break;case"Dec":t="month_12_abbr"}return this.trans("messages."+t)},initAlltime:function(){this.initCommonOptions();for(var e=0;e<4;e++)this.chart_pie[e]=null;this.graph_pie(0)},specieDetails:function(e){this.project=e.project,this.details=e,this.details.common_names&&this.details.common_names.length>45&&(this.specie_names_expanded=!1)},initCommonOptions:function(){var e=this;this.common_options={maintainAspectRatio:!1,responsive:!1,scales:{yAxes:[{id:"trees-y-axis",position:"right",ticks:{display:!0,beginAtZero:!0,min:0},gridLines:{display:!0,drawOnChartArea:!1,drawBorder:!0},scaleLabel:{display:!0,labelString:e.trans("users.graph_number_of_trees")}},{id:"compensation-y-axis",ticks:{display:!0,beginAtZero:!0,min:0},gridLines:{display:!0,drawBorder:!0},scaleLabel:{display:!0,labelString:e.trans("users.graph_tons_co2")}}],xAxes:[{type:"time",ticks:{display:!0,source:"labels",callback:function(t,a,r){return 0==a||a>0&&r[a-1]!=r[a]?e.translateThisLabel(t):""}},time:{unit:"day",displayFormats:{day:"MMM YYYY"}},gridLines:{display:!0,drawOnChartArea:!1,drawBorder:!0}}]},legend:{position:"bottom",reverse:!1},tooltips:{mode:"index",callbacks:{title:function(e,t){return moment(e[0].xLabel).format("DD MMM YYYY")},label:function(t,a){return 0==t.datasetIndex?e.trans("users.graph_tons_co2_tooltip",{number:Math.round(100*t.yLabel)/100}):e.trans("users.graph_trees_planted_tooltip",{number:t.yLabel})}}}}},total_planted:function(){var e=0;for(var t in this.aggregated.planted[this.current_filter])e+=1*this.aggregated.planted[this.current_filter][t].trees;return e},total_reforested:function(){var e=0;for(var t in this.aggregated.reforested[this.current_filter])e+=1*this.aggregated.reforested[this.current_filter][t].reforested;return Math.round(100*e)/100},total_co2:function(){var e=0;for(var t in this.aggregated.co2[this.current_filter])e+=1*this.aggregated.co2[this.current_filter][t].compensated_co2;return Math.round(100*e)/100},total_families_helped:function(){if(void 0===this.aggregated.planted)return 0;var e=0;for(var t in this.aggregated.planted[this.current_filter])e+=1*this.aggregated.planted[this.current_filter][t].families_helped;return e},total_planters_helped:function(){if(void 0===this.aggregated.planted)return 0;var e=0;for(var t in this.aggregated.planted[this.current_filter])e+=1*this.aggregated.planted[this.current_filter][t].planters_helped;return e},changeFilter:function(e){if(this.current_filter=e,this.to_tab(e),!this.periods_loaded[e])return!0;switch(e){case"alltime":this.graph_alltime();break;case"year":this.graph_year();break;case"quarter":this.graph_quarter();break;case"month":this.graph_month()}var t=this.periods_by_name[e];this.graph_pie(t),InitMaps.impactMap(t)},to_tab:function(e){this.period_has_data[e]||this.periods_loaded[e]?$("#data-container").show():$("#data-container").hide(),$(".forest-impact__trees-graph canvas").addClass("d-none"),$("#graph-"+e).removeClass("d-none"),$(".forest-impact__pie canvas").addClass("d-none"),$("#graph-pie-"+e).removeClass("d-none")},createGraph:function(e,t,a){var r=document.getElementById(e).getContext("2d"),i=new Chart(r,{type:"line",data:t,options:a}),s=i.scales["trees-y-axis"].max;(s*=1.5)<10&&(s=10),i.options.scales.yAxes[0].ticks.max=s;var o=i.scales["compensation-y-axis"].max;return o<10&&(o=10),i.options.scales.yAxes[1].ticks.max=o,i.update(),i},build_data:function(e){var t=this;return{labels:t.graph_data[e].labels,datasets:[{label:t.trans("users.graph_compensation"),yAxisID:"compensation-y-axis",data:t.graph_data[e].compensation,backgroundColor:"transparent",borderColor:"#50BCE7",borderWidth:2,pointStyle:"circle",pointBorderWidth:1,pointBackgroundColor:"#BCE1F2",steppedLine:!0},{label:t.trans("users.graph_trees_planted"),yAxisID:"trees-y-axis",data:t.graph_data[e].trees,backgroundColor:"#CEE8D3",borderColor:"#49BC6B",borderWidth:1,pointStyle:"circle",pointBorderWidth:1,pointBackgroundColor:"#CEE8D3",steppedLine:!0}]}},build_pie_data:function(e){var t,a=getComputedStyle(document.body),r=this.aggregated.species_categories[["alltime","year","quarter","month"][e]],i=[],s=[],o=[];for(var n of Object.keys(r))i.push(r[n].name),s.push(r[n].pct),t=a.getPropertyValue("--"+r[n].code),o.push(t.trim());return{labels:i,datasets:[{data:s,backgroundColor:o,borderWidth:0}]}},build_annotations:function(e){var t="";switch(e){case 0:t="alltime";break;case 1:t="year";break;case 2:t="quarter";break;case 3:t="month"}var a=[];return"citizen"==this.profile.type&&(a=[{drawTime:"afterDatasetsDraw",id:"hline",type:"line",mode:"horizontal",scaleID:"compensation-y-axis",value:9,borderColor:"#50BCE7",borderWidth:2,label:{content:this.trans("users.graph_goal_for_the_"+t),enabled:!0,position:"left",backgroundColor:"transparent",fontColor:"#50BCE7",yAdjust:-10}}]),a},graph_month:function(){var e=this;if(null==e.chart_month){var t=e.build_data(3),a=e.build_annotations(3),r=this.common_options;r.scales.xAxes[0].time={unit:"day",displayFormats:{day:"D"}},r.tooltips.annotation={annotations:a},e.chart_month=this.createGraph("graph-month",t,r)}},graph_quarter:function(){var e=this;if(null==e.chart_quarter){var t=e.build_data(2),a=e.build_annotations(2),r=this.common_options;r.scales.xAxes[0].time={unit:"month",displayFormats:{month:"MMMM Y"}},r.tooltips.annotation={annotations:a},e.chart_quarter=this.createGraph("graph-quarter",t,r)}},graph_alltime:function(){var e=this;if(null==e.chart_alltime){var t=e.build_data(0),a=this.common_options;a.scales.xAxes[0].time={unit:"day",displayFormats:{day:"MMM YYYY"}},e.chart_alltime=this.createGraph("graph-alltime",t,a)}},graph_year:function(){var e=this;if(null==e.chart_year){var t=e.build_data(1),a=[];"citizen"==e.profile.user_type&&(a=[{drawTime:"afterDatasetsDraw",id:"hline",type:"line",mode:"horizontal",scaleID:"compensation-y-axis",value:9,borderColor:"#50BCE7",borderWidth:2,label:{content:e.trans("users.graph_goal_for_the_year"),enabled:!0,position:"left",backgroundColor:"transparent",fontColor:"#50BCE7",yAdjust:-10}}]);var r=this.common_options;r.scales.xAxes[0].time={unit:"month",displayFormats:{month:"MMMM"}},r.tooltips.annotation={annotations:a},e.chart_year=this.createGraph("graph-year",t,r)}},graph_pie:function(e){var t=this;if(null==t.chart_pie[e]){var a=t.build_pie_data(e),r=document.getElementById("graph-pie-"+["alltime","year","quarter","month"][e]).getContext("2d"),i=new Chart(r,{type:"doughnut",data:a,options:{legend:{display:!1},cutoutPercentage:60,layout:{padding:{left:10,right:10,top:10,bottom:10}}}});i.update(),t.chart_pie[e]=i}},graph_web:function(){var e=this,t={labels:e.web_data.labels_web,datasets:[{label:e.trans("users.graph_compensation"),yAxisID:"compensation-y-axis",data:e.web_data.compensation_web,backgroundColor:"transparent",borderColor:"#50BCE7",borderWidth:2,pointStyle:"circle",pointBorderWidth:1,pointBackgroundColor:"#BCE1F2",steppedLine:!0}]},a=document.getElementById("js--graph-co2-web").getContext("2d");e.chart_web=new Chart(a,{type:"line",data:t,options:{scales:{yAxes:[{id:"compensation-y-axis",ticks:{display:!0,beginAtZero:!0,min:0},gridLines:{display:!0,drawBorder:!0},scaleLabel:{display:!0,labelString:e.trans("users.graph_grams_co2")}}],xAxes:[{type:"time",ticks:{display:!0,source:"labels",callback:function(t,a,r){return 0==a||a>0&&r[a-1]!=r[a]?e.translateThisLabel(t):""}},time:{unit:"day",displayFormats:{day:"MMM YYYY"}},gridLines:{display:!0,drawOnChartArea:!1,drawBorder:!0}}]},legend:{position:"bottom",reverse:!1},tooltips:{mode:"index",callbacks:{title:function(e,t){return moment(e[0].xLabel).format("DD MMM YYYY")},label:function(t,a){if(0==t.datasetIndex)return e.trans("users.graph_grams_co2_tooltip",{number:Math.round(100*t.yLabel)/100})}}}}});var r=e.chart_web.scales["compensation-y-axis"].max;r<10&&(r=10),e.chart_web.options.scales.yAxes[0].ticks.max=r,e.chart_web.update()},activateTracking:function(){this.$http.post(ajax_url+"/userProfile/activateTracking",{user_id:user.id}).then((function(e){this.loggedUser(e.data),"loggedOut"!=e.data&&"wrongUser"!=e.data&&(this.tracking_code=e.data,$("#co2-website-code-modal").modal("show"))}))},loadPeriods:function(e){var t=1,a=3,r="/profile/impactPeriods",i=[1,2,3];e&&(t=0,a=0,r="/profile/impactPeriods",i=[0]);for(var s=t;s<=a;s++)this.period_has_data[this.periods_by_id[s]]=!1;this.$http.post(ajax_url+r,{profile_id:profile.id,periods_to_calc:i}).then((function(r){var i=Object.assign({},r.data.aggregated);if(e)this.aggregated=Object.assign({},r.data.aggregated),this.graph_data=r.data.graph_data,this.map_projects=r.data.map_projects;else{for(var s in i)i.hasOwnProperty(s)&&(this.aggregated[s]=Object.assign({},this.aggregated[s],i[s]));this.graph_data=Object.assign({},this.graph_data,r.data.graph_data),this.map_projects=Object.assign({},this.map_projects,r.data.map_projects)}map_projects=this.map_projects;for(var o=t;o<=a;o++){var n=this.periods_by_id[o];this.period_has_data[n]=0<this.aggregated.planted[n].length+this.aggregated.reforested[n].length+this.aggregated.co2[n].length,this.periods_loaded[this.periods_by_id[o]]=!0}e?(this.initAlltime(),this.changeFilter(this.current_filter),this.loadPeriods(!1)):this.changeFilter(this.current_filter)}))},loadWebData:function(){var e=this;$.getJSON(ajax_url_new+"/profile/impact-web/"+this.profile.id).then((function(t){e.web_data=t.data.web_data,e.has_web_data=t.data.has_web_data,e.web_data_loaded=!0,e.web_data.compensation_web.length&&e.graph_web(),e.has_web_data&&($("#js--graph-co2-web").removeClass("d-none"),$(".forest-impact__co2-web").show())}))}}});